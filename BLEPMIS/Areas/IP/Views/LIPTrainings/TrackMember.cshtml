@model DAL.Models.Domain.Training.LIPAssetTransfer
@{
    ViewBag.Title = "Tracking";
    ViewBag.pTitle = "Beneficiary";
    ViewBag.pageTitle = "Beneficiary";
    Layout = "~/Views/_Shared/_Layout.cshtml";
}

<link rel="stylesheet" type="text/css" href="~/assets/libs/toastr/build/toastr.min.css">
<link href="~/assets/libs/sweetalert2/sweetalert2.min.css" rel="stylesheet" type="text/css" />
<div class="card">
    <div class="card-body">
        <div class="row">
            <div class="col-md-12">
                <div id="FetchDataOnFailed" style="display:none" class="alert alert-danger alert-dismissible fade show" role="alert">
                    <div id="FetchDataOnFailedText"></div>
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="form-inline">
                    <label class="sr-only" for="inlineFormemail2">Email</label>
                    <div class="input-group mb-2 mr-sm-3">
                        <div class="input-group-prepend">
                            <div class="input-group-text">CNIC/Identity</div>
                        </div>
                        <input id="txtbox" class="form-control inputBox input-mask" data-inputmask="'mask': '***99-9999999-9'" />
                    </div>
                    <button onclick="fetch()" type="button" class="btn btn-info waves-effect btn-label waves-light ml-2 mb-2"><i class="bx bx-check-double label-icon"></i> Search</button>
                    <div id="fetchspinner" style="display:none" class="spinner-grow text-dark m-2 mb-3" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="row applicantinformation" style="display:none;">    
            <form asp-action="Create" enctype="multipart/form-data" class="custom-validation">
            <div class="row">
            <div class="col-md-3">
                <input type="hidden" asp-for="MemberId" />
                <div class="form-group">
                    <label class="control-label">Name</label>
                    <input style="background-color:aliceblue" id="MemberName" class="form-control" disabled="disabled" />
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label class="control-label">Father Name</label>
                    <input style="background-color:aliceblue" id="FatherName" class="form-control" disabled="disabled" />
                </div>
            </div>
            <div class="col-md-2">
                <div class="form-group">
                    <label class="control-label">CNIC/Identity#</label>
                    <input style="background-color:aliceblue" id="CNIC" class="form-control" disabled="disabled" />
                </div>
            </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label class="control-label">Cell No</label>
                            <input style="background-color:aliceblue" id="CellNo" class="form-control" disabled="disabled" />
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label class="control-label">Gender</label>
                            <input style="background-color:aliceblue" id="Gender" class="form-control" disabled="disabled" />
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="control-label">District</label>                            
                            <input id="DistrictId" name="DistrictId" class="form-control" readonly="readonly" />
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="control-label">Tehsil</label>
                            <input id="TehsilId" class="form-control" readonly="readonly"/>                            
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="control-label">Union Council</label>                           
                            <input id="UnionCouncilId" class="form-control" readonly="readonly"/>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="control-label">Village</label>                            
                            <input id="VillageId" class="form-control" readonly="readonly"/>
                        </div>
                    </div>                        
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="control-label">PSC</label>
                            <input asp-for="PSC" class="form-control" required />
                        </div>
                    </div>
                <div class="col-md-3">
                <div class="form-group">
                    <label asp-for="LIPPackageId" class="control-label"></label>
                            <input asp-for="LIPPackageId" class="form-control" readonly="readonly" />
                </div>
            </div>
            <div class="col-md-3">
                    <div class="form-group">
                        <label asp-for="Latitute" class="control-label"></label>
                            <input asp-for="Latitute" type="number" min="-90.000000" max="90.000000" step="0.000001" class="form-control" readonly="readonly" />
                        <span asp-validation-for="Latitute" class="text-danger"></span>
                    </div>
            </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label asp-for="Longitute" class="control-label"></label>
                        <input asp-for="Longitute"  type="number" min="-90.000000" max="90.000000" step="0.000001" class="form-control" readonly="readonly"/>
                        <span asp-validation-for="Longitute" class="text-danger"></span>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="form-group">
                        <label asp-for="DataCollectedBy" class="control-label"></label>
                        <input asp-for="DataCollectedBy" class="form-control" readonly="readonly"/>
                        <span asp-validation-for="DataCollectedBy" class="text-danger"></span>
                    </div>
                        <div class="form-group">
                            <input type="submit" value="Save" class="btn btn-primary" />
                        </div>
            </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label asp-for="DataCollectorDesignation" class="control-label"></label>
                            <input asp-for="DataCollectorDesignation" class="form-control" readonly="readonly" />
                            <span asp-validation-for="DataCollectorDesignation" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label class="control-label" asp-for="IdentifiedById"></label>                           
                            <input asp-for="IdentifiedById" class="form-control" readonly="readonly" />
                        </div>
                    </div>
                    <div class="col-md-3">
                        @{
                            if (Model.LIPFormAttachment != null)
                            {
                                <div class="col-md-3">
                                    <div class="form-group" style="margin-bottom:0.5rem">
                                        <label class="control-label">Uploaded LIP Form</label>
                                    </div>
                                    <div class="form-group">
                                        <div data-toggle="modal" data-target="#myModal" onclick="createModal('@Model.LIPFormAttachment')" class="btn btn-info btn-sm"><i class="bx bxs-file label-icon"></i> View</div>
                                    </div>
                                </div>
                            }
                        }
                    </div>
                   @* <div class="col-md-3">
                        <div class="form-group">
                            <label asp-for="GRNAttachment" class="control-label"></label>
                            <input type="file" name="GRNAttachment" class="form-control" accept="application/pdf" required/>
                            <span asp-validation-for="GRNAttachment" class="text-danger"></span>
                        </div>
                    </div>*@
                    <div class="col-md-3">
                        <div class="form-group">
                            <label asp-for="CNICAttachment" class="control-label"></label>
                            <input type="file" name="CNICAttachment" class="form-control" accept="application/pdf" />
                            <span asp-validation-for="CNICAttachment" class="text-danger"></span>
                        </div>
                    </div>
                    @*<div class="col-md-3">
                        <div class="form-group">
                            <label class="control-label">Handing Taking Picture</label>
                            <input accept="image/png, image/gif, image/jpeg" type="file" name="PictureAttachment1" class="form-control" accept="application/pdf" required/>
                        </div>
                    </div>*@
           @* <div class="col-md-3">
                <div class="form-group">
                    <label class="control-label">Select Member</label>
                    <button type="button" onclick="AddBeneficiaryInTraining()" class="form-control btn btn-outline-info waves-effect btn-label waves-light"><i class="bx bx bx-add-to-queue label-icon"></i> Add Member as Trainer</button>
                </div>
            </div>*@
                </div>
            </form>
        </div>
        <div id="dynamicContentContainer"></div>
    </div>
</div>
<div class="container">
    <div id="myModal" class="modal fade" role="dialog">
        <div class="modal-dialog modal-lg">

            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    <embed id="pdfFile" src="" frameborder="0" width="100%" height="100%">
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <!-- form mask -->
    <script src="~/assets/libs/inputmask/min/jquery.inputmask.bundle.min.js"></script>
    <!-- form mask init -->
    <script src="~/assets/js/pages/form-mask.init.js"></script>
    <!-- toastr plugin -->
    <script src="~/assets/libs/toastr/build/toastr.min.js"></script>
    <!-- Sweet Alerts js -->
    <script src="~/assets/libs/sweetalert2/sweetalert2.min.js"></script>
    <script src="~/assets/libs/parsleyjs/parsley.min.js"></script>
    <script src="~/assets/js/pages/form-validation.init.js"></script>
    <script>
        $(document).ready(function () {
            var id = '@ViewBag.Id';
            if (id != "") {
                $("#txtbox").val(id);
                fetch();
            }
            //$("#DistrictId").change(function () {
            //    $.get("/CommunityInstitutions/GetTehsils", { districtId: $("#DistrictId").val() }, function (data) {
            //        $("#TehsilId").empty();
            //        $("#UnionCouncilId").empty();
            //        $("#UnionCouncilId").append('<option>Select...</option>');
            //        $("#TehsilId").append('<option>Select...</option>');
            //        console.log(data);
            //        $.each(data, function (index, row) {
            //            console.log(row);
            //            $("#TehsilId").append("<option value='" + row.value + "'>" + row.text + "</option>")
            //        });
            //    });
            //    return false;
            //});
            //$("#TehsilId").change(function () {
            //    $("#UnionCouncilId").empty();
            //    $.get("/CommunityInstitutions/GetUCs", { tehsilId: $("#TehsilId").val() }, function (data) {
            //        $("#UnionCouncilId").empty();
            //        $("#UnionCouncilId").append('<option>Select...</option>');
            //        console.log(data);
            //        $.each(data, function (index, row) {
            //            console.log(row);
            //            $("#UnionCouncilId").append("<option value='" + row.value + "'>" + row.text + "</option>")
            //        });
            //    });
            //    return false;
            //});
            //$("#UnionCouncilId").change(function () {
            //    $("#VillageId").empty();
            //    $.get("/CommunityInstitutions/GetVillages", { ucId: $("#UnionCouncilId").val() }, function (data) {
            //        $("#VillageId").empty();
            //        $("#VillageId").append('<option>Select...</option>');
            //        console.log(data);
            //        $.each(data, function (index, row) {
            //            console.log(row);
            //            $("#VillageId").append("<option value='" + row.value + "'>" + row.text + "</option>")
            //        });
            //    });
            //    return false;
            //});
            UpdateRecord();
        });
        function UpdateRecord() {
            $.get('@Url.Action("_Index","MemberTrainingDetails", new { id=ViewBag.MTId })', function (content) {
                $("#dynamicContentContainer").html(content);
            });
        }
        function fetch() {
            var id = $("#txtbox").val();
            var currentdistrictId = '@ViewBag.CurrentDistrict';
            $('#fetchspinner').show();
            $.ajax({
                type: "POST",
                url: "/LIPAssetTransfers/AjaxMemberInformation",
                data: { id: id, currentdistrictId: currentdistrictId },
                dataType: "json",
                success: function (response) {
                    debugger;
                    if (response.isValid) {
                        if (response.isDuplicate){
                            notificationme('Member already selected as LIP Asset Transfer beneficiary!', 0);
                        }else{
                            $('.applicantinformation').show();
                            $('#MemberName').val(response.info.member.memberName);
                            $('#MemberId').val(response.info.memberId);
                            $('#FatherName').val(response.info.member.fatherName);
                            $('#CNIC').val(response.info.member.cnic);
                            $('#CellNo').val(response.info.member.cellNo);
                            $('#Gender').val(response.info.member.gender);
                            $('#DistrictId').val(response.info.member.village.unionCouncil.tehsil.district.name);
                            $('#TehsilId').val(response.info.member.village.unionCouncil.tehsil.tehsilName);
                            $('#UnionCouncilId').val(response.info.member.village.unionCouncil.unionCouncilName);
                            $('#VillageId').val(response.info.member.village.name);
                            $('#Latitute').val(response.info.latitute);
                            $('#Longitute').val(response.info.longitute);
                            $('#DataCollectedBy').val(response.info.dataCollectedBy);
                            $('#DataCollectorDesignation').val(response.info.dataCollectorDesignation);
                            $('#IdentifiedById').val(response.info.identifiedBy.name);
                            $('#LIPPackageId').val(response.info.lIPPackage.name);
                            notificationme('Fetch data successfully!', 1);
                        }
                                            
                    } else {
                        $('.applicantinformation').hide();
                        notificationme('Beneficiary data not found!', 0);
                    }
                    $('#fetchspinner').hide();
                },
                failure: function (response) {
                    alert(response.responseText);
                },
                error: function (response) {
                    alert(response.responseText);
                }
            });
        }
        function notificationme(message, val) {
            toastr.options = {
                "closeButton": false,
                "debug": false,
                "newestOnTop": false,
                "progressBar": true,
                "preventDuplicates": true,
                "onclick": null,
                "showDuration": "100",
                "positionClass": "toast-bottom-right",
                "hideDuration": "1000",
                "timeOut": "5000",
                "extendedTimeOut": "1000",
                "showEasing": "swing",
                "hideEasing": "linear",
                "showMethod": "show",
                "hideMethod": "hide"
            };
            if (val == 1) {
                toastr.success(message);
            } else {
                toastr.error(message);
            }
        }

        function AddBeneficiaryInTraining() {
            var CDMId = $("#CDMId").val();
            var MTId = '@ViewBag.MTId';
            Swal.fire({
                title: "Are you sure?",
                text: 'You want to add member in selected training as a trainer!"',
                type: "success",
                showCancelButton: !0, confirmButtonColor: "#34c38f",
                cancelButtonColor: "#f46a6a",
                confirmButtonText: "Yes, Add it!"
            }).then(function (t) {
                if (t.value == true) {
                    $.ajax({
                        type: "POST",
                        url: "/MemberTrainingDetails/AddBeneficiaryInTraining",
                        data: { CDMId: CDMId, MTId: MTId },
                        dataType: "json",
                        success: function (response) {
                            if (response != null) {
                                if (response.isValid) {
                                    Swal.fire("Back", response.message, "success");
                                    $('.applicantinformation').hide();
                                    UpdateRecord();
                                } else {
                                    notificationme(response.message);
                                }
                            }
                        },
                        failure: function (response) {
                            alert(response.responseText);
                        },
                        error: function (response) {
                            alert(response.responseText);
                        }
                    });
                }
            })
        }
        function createModal(url) {
            $("#pdfFile").attr("src", url);
        }
    </script>
}
